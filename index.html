<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Allocation Buddy - Compact Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root { 
      --pink-1:#ff69b4; --pink-2:#ff1493; --pink-light:#ffb6c1; 
      --ink-1:#2c2c2c; --ink-2:#1a1a1a; --light:#ffffff; --muted:#fce4ec; 
      --success:#4caf50; --warning:#ff9800; --danger:#f44336;
      --gradient-primary:linear-gradient(135deg, var(--pink-1) 0%, var(--pink-2) 100%);
      --gradient-dark:linear-gradient(135deg, var(--ink-1) 0%, var(--ink-2) 100%);
      --gradient-success:linear-gradient(135deg, var(--success) 0%, #388e3c 100%);
      --gradient-warning:linear-gradient(135deg, var(--warning) 0%, #f57c00 100%);
      --gradient-danger:linear-gradient(135deg, var(--danger) 0%, #d32f2f 100%);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--gradient-primary);min-height:100vh;padding:15px;color:#111;}
    .container{max-width:1400px;margin:0 auto;background:var(--light);border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;}
    .header{background:var(--gradient-dark);color:var(--light);padding:25px 40px;text-align:center;position:relative;}
    .header h1{font-size:2.2em;margin-bottom:8px;font-weight:300;}
    .help-button{position:absolute;top:20px;left:20px;}
    .help-button button{padding:8px 12px;font-size:12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:6px;cursor:pointer;transition:all .3s ease;}
    .help-button button:hover{background:rgba(255,255,255,0.3);border-color:rgba(255,255,255,0.5);}
    .dark-mode-toggle{position:absolute;top:20px;right:20px;display:flex;align-items:center;gap:12px;color:#fff;font-size:14px;font-weight:500;z-index:10;}
    .toggle-switch{width:50px;height:24px;background:rgba(255,255,255,.2);border-radius:12px;position:relative;cursor:pointer;transition:all .3s ease;border:2px solid rgba(255,255,255,.3);}
    .toggle-switch:hover{background:rgba(255,255,255,.3);border-color:rgba(255,255,255,.5);}
    .toggle-switch::after{content:"";position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:1px;left:1px;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,.2);}
    .toggle-switch.active{background:var(--pink-1);border-color:var(--pink-1);}
    .toggle-switch.active::after{transform:translateX(26px);}
    .toggle-icon{font-size:16px;transition:all .3s ease;}
    .dashboard{padding:25px;display:grid;grid-template-columns:350px 1fr;gap:25px;}
    .sidebar,.main-area{display:flex;flex-direction:column;gap:20px;}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    .card h3{color:var(--ink-1);margin-bottom:15px;font-size:1.1em;display:flex;align-items:center;gap:8px;}
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;}
    .stat-card{background:var(--gradient-primary);color:#fff;padding:20px;border-radius:10px;text-align:center;}
    .stat-value{font-size:2.2em;font-weight:bold;display:block;}
    .stat-label{font-size:0.9em;opacity:0.9;margin-top:5px;}
    .import-tabs{display:flex;background:#f8f9fa;border-radius:8px;padding:3px;margin-bottom:15px;}
    .import-tab{flex:1;padding:8px 15px;background:transparent;border:none;border-radius:5px;cursor:pointer;font-weight:500;transition:all 0.3s ease;text-align:center;font-size:14px;}
    .import-tab.active{background:var(--pink-1);color:white;}
    .import-tab:hover:not(.active){background:rgba(255,105,180,0.1);}
    .import-content{display:none;}
    .import-content.active{display:block;}
    .upload-area{border:2px dashed #ddd;border-radius:8px;padding:20px;text-align:center;background:#fef5f8;}
    .upload-area:hover{border-color:var(--pink-1);background:#ffe0ec;}
    .store-list{max-height:300px;overflow-y:auto;border:1px solid #eee;border-radius:6px;padding:10px;}
    .store-item{display:flex;align-items:center;padding:8px;margin:2px 0;background:#f8f9fa;border-radius:4px;font-size:14px;}
    .store-item input{margin-right:10px;}
    .store-item .info{flex:1;display:flex;align-items:center;gap:10px;}
    .store-item .code{font-weight:bold;min-width:40px;}
    .store-item .name{font-size:12px;color:#666;}
    .rank-badge{background:var(--pink-1);color:#fff;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:500;}
    .rank-badge.rank-aa{background:#FFD700!important;color:#000!important;}
    .rank-badge.rank-a{background:#FF4500!important;color:#fff!important;}
    .rank-badge.rank-b{background:#1E90FF!important;color:#fff!important;}
    .rank-badge.rank-c{background:#32CD32!important;color:#fff!important;}
    .remove-btn{background:var(--danger);color:#fff;border:none;border-radius:3px;padding:3px 6px;cursor:pointer;font-size:11px;}
    .add-store{display:grid;gap:10px;}
    .add-store input,.add-store select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;}
    .queue{max-height:250px;overflow-y:auto;}
    .queue-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin:5px 0;background:#f8f9fa;border-radius:6px;font-size:14px;}
    .queue-item .details{font-size:12px;color:#666;margin-top:2px;}
    .big-button{background:var(--gradient-primary);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .3s ease;}
    .big-button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,105,180,.3);}
    .big-button.success{background:var(--gradient-success);}
    .big-button.warning{background:var(--gradient-warning);}
    .big-button.danger{background:var(--gradient-danger);}
    .big-button.large{font-size:16px;padding:15px 25px;}
    .big-button:disabled{opacity:0.55;cursor:not-allowed;}
    .hidden{display:none;}
    .simple-alert{padding:12px;border-radius:6px;margin:10px 0;font-size:14px;}
    .alert-info{background:#ffe0ec;border:1px solid #ffb6c1;color:var(--ink-1);}
    .alert-success{background:#e8f5e8;border:1px solid #c8e6c9;color:var(--ink-1);}
    .alert-warning{background:#fff3e0;border:1px solid #ffcc80;color:var(--ink-1);}
    .alert-danger{background:#ffebee;border:1px solid #ffcdd2;color:var(--ink-1);}
    .store-panes{margin:20px 0;}
    .store-pane{background:#fff;border:2px solid #ddd;border-radius:12px;margin-bottom:20px;overflow:hidden;}
    .store-pane-header{background:var(--pink-1);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .store-pane-title{font-weight:bold;font-size:18px;display:flex;align-items:center;gap:10px;}
    .store-pane-stats{font-size:14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .copy-btn{background:#ffffff;color:#1a1a1a;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:600;}
    .copy-btn:hover{filter:brightness(0.95);}
    .copied-badge{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;padding:3px 8px;border-radius:9999px;font-size:12px;font-weight:700;}
    .store-pane-body{padding:10px 12px 16px;}
    .store-pane-table{width:100%;border-collapse:collapse;}
    .store-pane-table th{background:#f8f9fa;padding:10px;text-align:left;border-bottom:2px solid #dee2e6;font-weight:600;}
    .store-pane-table td{padding:8px 10px;border-bottom:1px solid #eee;}
    .store-pane-table tr:hover{background:#f8f9fa;}
    .store-pane-table tr:nth-child(even){background:#fafafa;}
    .collapse-toggle{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.35);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;}
    .chev{display:inline-block;transition:transform .2s ease;}
    .collapsed .chev{transform:rotate(-90deg);}
    .collapsed .store-pane-body{display:none;}
    .store-pane-table tr.redistributed-row{background:#e8f5e8!important;}
    .delta-badge{display:inline-block;margin-left:8px;padding:2px 8px;font-size:11px;border-radius:9999px;font-weight:700;background:#e8f5e8;border:1px solid #c8e6c9;color:#1b5e20;line-height:1.4;vertical-align:middle;}
    .legend-note{font-size:12px;color:#2e7d32;margin:8px 0 -4px 0;}
    #fullResultsSection{background:var(--muted);padding:25px;margin-top:0;}
    .results-shell{max-width:1400px;margin:0 auto;background:var(--light);border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);padding:30px;}
    #helpOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;}
    .help-content{background:var(--light);border-radius:12px;padding:30px;max-width:600px;max-height:80vh;overflow-y:auto;margin:20px;position:relative;color:var(--ink-1);}
    .help-close{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;font-size:13px;box-shadow:0 8px 20px rgba(0,0,0,.25);opacity:0;pointer-events:none;transform:translateY(10px);transition:opacity .2s ease,transform .2s ease;z-index:9999;}
    .toast.show{opacity:1;transform:translateY(0);}
    .toast-light{background:#f8fafc;color:#111;border:1px solid #e5e7eb;}
    body.dark-mode{background:linear-gradient(135deg,var(--ink-2) 0%,#000000 100%);color:#fce4ec;}
    body.dark-mode .container{background:#0a0a0a;color:#fce4ec;}
    body.dark-mode .card{background:#1a1a1a;border-color:#333;color:#fce4ec;}
    body.dark-mode .card h3{color:#ffb6c1;}
    body.dark-mode .store-item{background:#222;color:#fce4ec;}
    body.dark-mode .store-item .name{color:#ffb6c1;}
    body.dark-mode .queue-item{background:#222;color:#fce4ec;}
    body.dark-mode .queue-item .details{color:#ffb6c1;}
    body.dark-mode .import-tabs{background:#1a1a1a;}
    body.dark-mode .import-tab{color:#fce4ec;}
    body.dark-mode .import-tab.active{background:var(--pink-1);color:#fff;}
    body.dark-mode .upload-area{background:#1a1a1a;border-color:#333;}
    body.dark-mode .upload-area:hover{background:#222;}
    body.dark-mode input,body.dark-mode select,body.dark-mode textarea{background:#1a1a1a;color:#fce4ec;border-color:#333;}
    body.dark-mode ::placeholder{color:#9e9e9e;}
    body.dark-mode #fullResultsSection{background:#000000;}
    body.dark-mode .results-shell{background:#0a0a0a;color:#fce4ec;}
    body.dark-mode .results-shell h2{color:#ffb6c1;}
    body.dark-mode .store-pane{background:#1a1a1a;border-color:#333;}
    body.dark-mode .store-pane-header{background:linear-gradient(135deg,#d81b60 0%,#c2185b 100%);}
    body.dark-mode .store-pane-table th{background:#222;color:#ffb6c1;border-bottom-color:#444;}
    body.dark-mode .store-pane-table td{border-bottom-color:#333;color:#fce4ec;}
    body.dark-mode .store-pane-table tr:hover{background:#222;}
    body.dark-mode .store-pane-table tr:nth-child(even){background:#1a1a1a;}
    body.dark-mode .store-pane-table tr.redistributed-row{background:#1a3d1a!important;}
    body.dark-mode .delta-badge{background:#1a3d1a;border-color:#2e5e2e;color:#90ee90;}
    body.dark-mode .legend-note{color:#90ee90;}
    body.dark-mode .simple-alert{color:#fce4ec;}
    body.dark-mode .alert-info{background:#330a1c;border-color:#d81b60;color:#ffb6c1;}
    body.dark-mode .alert-success{background:#0a2e0a;border-color:#2e5e2e;color:#90ee90;}
    body.dark-mode .alert-warning{background:#331a00;border-color:#664000;color:#ffb366;}
    body.dark-mode .alert-danger{background:#330a0a;border-color:#661414;color:#ff9999;}
    body.dark-mode .copy-btn{background:#000;color:#ffb6c1;border:1px solid #333;}
    body.dark-mode .copied-badge{background:#1a3d1a;border-color:#2e5e2e;color:#90ee90;}
    body.dark-mode .collapse-toggle{background:#000;border-color:#333;color:#fce4ec;}
    body.dark-mode .help-content{background:#1a1a1a;color:#fce4ec;}
    body.dark-mode .help-close{color:#ffb6c1;}
    @media (max-width:1200px){
      .dashboard{grid-template-columns:1fr;padding:20px;}
      .stats-row{grid-template-columns:repeat(2,1fr);}
    }
  </style>
</head>
<body class="dark-mode">
  <div class="container">
    <div class="header">
      <div class="help-button">
        <button onclick="showHelpOverlay()" title="Show help guide">❓ Help</button>
      </div>
      <h1>Allocation Buddy</h1>
      <p>Compact dashboard for sorting inventory by store destination</p>
      <div class="dark-mode-toggle">
        <span class="toggle-icon" id="modeIcon">🌙</span>
        <div class="toggle-switch" onclick="toggleDarkMode()" id="toggleSwitch" aria-label="Toggle dark mode"></div>
      </div>
    </div>

    <div class="dashboard">
      <div class="sidebar">
        <div class="card">
          <h3>🪪 Store Management</h3>
          <div class="import-tabs">
            <button class="import-tab active" onclick="switchTab('store','manage')">📋 Manage Stores</button>
            <button class="import-tab" onclick="switchTab('store','add')">➕ Add Store</button>
          </div>

          <div class="import-content active" id="manage-content">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;font-size:14px;">
              <span>Active: <strong id="activeStoreCount">0</strong></span>
              <span>Inactive: <strong id="inactiveStoreCount">0</strong></span>
              <div>
                <button class="big-button" onclick="toggleAllStores(true)" style="padding:4px 8px;font-size:12px;margin-right:5px;">All</button>
                <button class="big-button" onclick="toggleAllStores(false)" style="padding:4px 8px;font-size:12px;">None</button>
              </div>
            </div>
            <div class="store-list" id="storeStatusContainer"></div>
          </div>

          <div class="import-content" id="add-content">
            <div class="add-store">
              <input type="text" id="newStoreCode" placeholder="Store Code"/>
              <input type="text" id="newStoreName" placeholder="Store Name"/>
              <select id="newStoreRank">
                <option value="AA">AA - Premium</option>
                <option value="A">A - High</option>
                <option value="B" selected>B - Standard</option>
                <option value="C">C - Regular</option>
              </select>
              <label style="display:flex;align-items:center;gap:8px;font-size:14px;">
                <input type="checkbox" id="newStoreActive" checked/> Start as active
              </label>
              <button class="big-button success" onclick="addNewStore()">Add Store</button>

              <!-- New: Re-add default stores button -->
              <button class="big-button warning" onclick="restoreDefaults()" style="margin-top:10px;">
                Re-Add Default Stores
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="main-area">
        <div class="stats-row">
          <div class="stat-card"><span class="stat-value" id="itemCount">0</span><div class="stat-label">Items to Sort</div></div>
          <div class="stat-card"><span class="stat-value" id="storeDestinationCount">0</span><div class="stat-label">Destinations</div></div>
          <div class="stat-card"><span class="stat-value" id="activeStoreCount2">0</span><div class="stat-label">Active Stores</div></div>
          <div class="stat-card"><span class="stat-value" id="totalProcessed">0</span><div class="stat-label">Processed</div></div>
        </div>

        <div class="card">
          <h3>📤 Import Data</h3>
          <div class="import-tabs">
            <button class="import-tab active" onclick="switchTab('import','upload')">📄 Upload Excel</button>
            <button class="import-tab" onclick="switchTab('import','paste')">📋 Paste Data</button>
          </div>

          <div class="import-content active" id="upload-content">
            <div class="upload-area">
              <h4>Upload Excel File</h4>
              <p style="margin:10px 0;font-size:14px;color:#666;">Choose .xlsx, .xlsm, or .xls files</p>
              <p style="margin:5px 0;font-size:12px;color:#888;">✨ Supports store codes OR store names</p>
              <input type="file" id="fileInput" accept=".xlsx,.xlsm,.xls" onchange="handleFileUpload(event)" style="display:none;"/>
              <button class="big-button" onclick="document.getElementById('fileInput').click()">Choose File</button>
              <div id="fileStatus" style="font-size:12px;margin-top:10px;"></div>
            </div>
          </div>

          <div class="import-content" id="paste-content">
            <div style="text-align:center;margin-bottom:15px;">
              <h4>Paste Data</h4>
              <p style="font-size:14px;color:#666;margin:5px 0;">Copy from Excel and paste below</p>
              <p style="font-size:12px;color:#888;">Format: ItemNumber, Quantity, StoreCode/StoreName</p>
            </div>
            <textarea id="pasteArea" placeholder="Example:&#10;NSN-0402-21, 10, 101&#10;NSN-0405-04, 20, NIAGARA 1&#10;NSN-0405-05, 15, MISSISSAUGA" style="width:100%;height:100px;font-size:12px;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;"></textarea>
            <button class="big-button success" onclick="processPastedData()" style="margin-top:10px;width:100%;">Process Data</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">
          <div class="card">
            <h3>📦 Import Queue</h3>
            <div class="queue" id="importContainer">
              <div class="simple-alert alert-info">No items imported yet.</div>
            </div>
            <button class="big-button danger hidden" onclick="clearImport()" id="clearBtn" style="margin-top:10px;">Clear All</button>
          </div>

          <div class="card">
            <h3>🚀 Actions</h3>
            <div id="sortingStatus" style="margin-bottom:15px;"></div>
            <button class="big-button success large" onclick="sortItems()" style="width:100%;margin-bottom:10px;">Sort by Store</button>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <button class="big-button" onclick="exportResults()">Export</button>
              <button class="big-button warning" onclick="startOver()">Reset</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="fullResultsSection" class="hidden">
    <div class="results-shell">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;">
        <h2 style="font-size:1.8em;display:flex;align-items:center;gap:12px;margin:0;">
          <span style="background:var(--pink-1);color:#fff;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:24px;">4</span>
          Sorting Results
        </h2>
      </div>
      <div id="resultsStatus" style="margin-bottom:10px;"></div>
      <div id="issuesContainer" class="hidden"></div>
      <div id="resultsContainer"></div>
    </div>
  </div>

  <!-- Help Overlay -->
  <div id="helpOverlay" style="display:none;">
    <div class="help-content">
      <button onclick="hideHelpOverlay()" class="help-close">×</button>
      
      <h2 style="color:var(--pink-1);margin-bottom:20px;">📚 Allocation Buddy Help</h2>
      
      <div style="line-height:1.6;">
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">🪪 Store Management</h3>
        <p>Manage your store list with codes, names, and priority ranks (AA=Premium, A=High, B=Standard, C=Regular). Toggle stores active/inactive and add new stores as needed.</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">📤 Import Data</h3>
        <p><strong>Excel Upload:</strong> Upload .xlsx/.xls files with Item, Quantity, and Store columns. Auto-detects headers and supports both store codes and store names.</p>
        <p><strong>Paste Data:</strong> Copy from Excel and paste. Format: ItemNumber, Quantity, StoreCode/StoreName (comma or tab separated).</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">🚀 Sort & Distribute</h3>
        <p><strong>Sort by Store:</strong> Organizes items by destination and identifies issues (inactive stores, missing stores).</p>
        <p><strong>Distribute Problem → Active:</strong> Automatically redistributes items from inactive or unknown stores to active ones using rank-weighted distribution.</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">📋 Copy & Export</h3>
        <p><strong>Copy Store Items:</strong> Click 📋 Copy to copy item lists (Tab-separated). Hold Alt for CSV format.</p>
        <p><strong>Export:</strong> Download complete results as Excel file with separate sheets for stores and issues.</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">🌙 Features</h3>
        <p>• Dark/Light mode toggle<br>• Collapsible store sections<br>• Real-time validation<br>• Rank-weighted redistribution<br>• Automatic store detection by code or name</p>
        
        <div class="pro-tip">
          <strong>💡 Pro Tip:</strong> Items assigned to inactive or unknown stores will be flagged. Use "Distribute Problem → Active" to automatically reallocate them based on store priority ranks.
        </div>
      </div>
    </div>
  </div>

  <div id="copyToast" class="toast">Copied!</div>

  <!-- Footer -->
  <footer class="footer">
    <div>
      <strong>Allocation Buddy</strong> - Inventory Management System
    </div>
    <div style="margin-top:8px;font-size:12px;opacity:0.8;">
      Copyright © 2025. All rights reserved. | Designed for efficient inventory allocation and distribution management.
    </div>
  </footer>

  <script>
    // Cache DOM elements
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelector(sel);
    const $$$ = sel => document.querySelectorAll(sel);
    
    // Constants
    const RANK_WEIGHTS = { AA: 4, A: 3, B: 2, C: 1 };
    const COOKIE_NAME = 'allocationBuddyPrefs';
    const COOKIE_DAYS = 365;

    // ---------- Defaults & helpers ----------
    const DEFAULT_STORES = Object.freeze([
      {code:'101',name:'WATERLOO 1',rank:'C',active:true},
      {code:'102',name:'KITCHENER 1',rank:'B',active:true},
      {code:'103',name:'CAMBRIDGE',rank:'B',active:true},
      {code:'104',name:'LONDON 1',rank:'B',active:true},
      {code:'105',name:'LONDON 2',rank:'B',active:true},
      {code:'106',name:'HAMILTON 1',rank:'C',active:true},
      {code:'107',name:'MISSISSAUGA',rank:'A',active:true},
      {code:'108',name:'ST CATHARINES',rank:'B',active:true},
      {code:'109',name:'HAMILTON 2',rank:'A',active:true},
      {code:'110',name:'TORONTO 1',rank:'A',active:true},
      {code:'111',name:'SCARBOROUGH',rank:'A',active:true},
      {code:'112',name:'WINDSOR 1',rank:'A',active:true},
      {code:'114',name:'TORONTO 2',rank:'A',active:true},
      {code:'115',name:'KITCHENER 2',rank:'C',active:true},
      {code:'116',name:'BRANTFORD',rank:'C',active:true},
      {code:'117',name:'NIAGARA 1',rank:'B',active:false},
      {code:'118',name:'BURLINGTON',rank:'A',active:true},
      {code:'119',name:'LONDON 3',rank:'B',active:true},
      {code:'120',name:'BARRIE 1',rank:'A',active:true},
      {code:'121',name:'OSHAWA',rank:'A',active:true},
      {code:'122',name:'BARRIE 2',rank:'A',active:true},
      {code:'123',name:'GUELPH',rank:'B',active:true},
      {code:'125',name:'TORONTO 3',rank:'A',active:true},
      {code:'126',name:'NIAGARA 2',rank:'C',active:true},
      {code:'127',name:'SARNIA',rank:'C',active:true},
      {code:'128',name:'OTTAWA 1',rank:'C',active:true},
      {code:'129',name:'OTTAWA 2',rank:'C',active:true},
      {code:'130',name:'TORONTO 4',rank:'A',active:true},
      {code:'131',name:'SUDBURY',rank:'B',active:true},
      {code:'132',name:'WINDSOR 2',rank:'B',active:true},
      {code:'133',name:'ST JOHNS',rank:'A',active:true},
      {code:'134',name:'PETERBOROUGH',rank:'B',active:true},
      {code:'135',name:'THUNDER BAY',rank:'A',active:true},
      {code:'199',name:'STAG WEB',rank:'AA',active:true}
    ]);
    const cloneDefaults = () => DEFAULT_STORES.map(s => ({...s}));

    // State
    let itemsToSort = [];
    let lastResults = null;
    let redistributionDeltas = {};
    let currentWorkbook = null;
    const collapsedStores = {};
    const copiedStores = {};
    let allStores = cloneDefaults(); // start from defaults

    // Utilities
    const setCookie = (name, value, days = COOKIE_DAYS) => {
      const date = new Date();
      date.setTime(date.getTime() + (days * 864e5));
      document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${date.toUTCString()};path=/;SameSite=Strict`;
    };

    const getCookie = name => {
      const nameEQ = name + "=";
      return document.cookie.split(';').reduce((acc, c) => {
        const cookie = c.trim();
        if (cookie.startsWith(nameEQ)) {
          try { return JSON.parse(decodeURIComponent(cookie.substring(nameEQ.length))); }
          catch(e) { return null; }
        }
        return acc;
      }, null);
    };

    const sortStoresNumerically = arr => arr.slice().sort((a, b) => 
      (parseInt(String(a.code || a.storeCode)) || 999999) - (parseInt(String(b.code || b.storeCode)) || 999999)
    );

    const findStoreByCodeOrName = identifier => {
      if (!identifier) return null;
      const searchStr = String(identifier).trim();
      return allStores.find(s => String(s.code) === searchStr) ||
             allStores.find(s => s.name.toUpperCase() === searchStr.toUpperCase()) ||
             allStores.find(s => s.name.toUpperCase().includes(searchStr.toUpperCase()));
    };

    const showStatus = (html, type = 'info') => {
      const alertClass = `alert-${type}`;
      const block = `<div class="simple-alert ${alertClass}">${html}</div>`;
      const statusElements = [$('sortingStatus'), $('resultsStatus')].filter(Boolean);
      statusElements.forEach(el => el.innerHTML = block);
    };

    const saveUserPreferences = () => {
      const preferences = {
        darkMode: document.body.classList.contains('dark-mode'),
        storeStates: allStores.map(s => ({code: s.code, active: s.active})),
        lastImportTab: getActiveImportTab(),
        lastStoreTab: $('.sidebar .import-tab.active')?.textContent?.includes('Manage') ? 'manage' : 'add'
      };
      setCookie(COOKIE_NAME, preferences);
    };

    const getActiveImportTab = () => {
      const activeTab = $('.main-area .import-tab.active')?.textContent;
      if (activeTab?.includes('Upload')) return 'upload';
      if (activeTab?.includes('Paste')) return 'paste';
      if (activeTab?.includes('How to Use')) return 'info';
      return 'upload';
    };

    const loadUserPreferences = () => {
      const prefs = getCookie(COOKIE_NAME);
      if (!prefs) return;

      // Dark mode
      if (prefs.darkMode !== undefined) {
        const isDark = prefs.darkMode;
        document.body.classList.toggle('dark-mode', isDark);
        $('toggleSwitch').classList.toggle('active', isDark);
        $('modeIcon').textContent = isDark ? '🌙' : '☀️';
      }

      // Store states (only apply active flags if they match existing codes)
      if (Array.isArray(prefs.storeStates)) {
        const codes = new Set(allStores.map(s => s.code));
        prefs.storeStates.forEach(savedStore => {
          if (codes.has(savedStore.code)) {
            const store = allStores.find(s => s.code === savedStore.code);
            if (store) store.active = !!savedStore.active;
          }
        });
      }

      // Restore tabs after DOM is ready
      setTimeout(() => {
        ['import', 'store'].forEach(type => {
          const tabName = prefs[`last${type.charAt(0).toUpperCase() + type.slice(1)}Tab`];
          if (tabName) switchTab(type, tabName, false);
        });
      }, 50);
    };

    // Help functions
    const showHelpOverlay = () => {
      $('helpOverlay').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };

    const hideHelpOverlay = () => {
      $('helpOverlay').style.display = 'none';
      document.body.style.overflow = 'auto';
    };

    // Tab management
    const switchTab = (section, tabName, save = true) => {
      const isStore = section === 'store';
      const container = isStore ? '.sidebar .card' : '.main-area .card';
      const tabs = $$$(`${container} .import-tab`);
      const contents = $$$(`${container} .import-content`);
      
      tabs.forEach(tab => tab.classList.remove('active'));
      contents.forEach(content => content.classList.remove('active'));
      
      const activeIndex = (isStore && tabName === 'add') || (!isStore && tabName === 'paste') ? 1 : 0;
      tabs[activeIndex]?.classList.add('active');
      $(`${tabName}-content`)?.classList.add('active');
      
      if (save) saveUserPreferences();
    };

    // Store management
    const updateStoreCounts = () => {
      const active = allStores.filter(s => s.active).length;
      const inactive = allStores.length - active;
      $('activeStoreCount').textContent = $('activeStoreCount2').textContent = active;
      $('inactiveStoreCount').textContent = inactive;
    };

    const updateStoreStatus = () => {
      updateStoreCounts();
      $('storeStatusContainer').innerHTML = sortStoresNumerically(allStores)
        .map(store => `
          <div class="store-item">
            <input type="checkbox" ${store.active ? 'checked' : ''} onchange="toggleStoreStatus('${store.code}', this.checked)"/>
            <div class="info">
              <span class="code">${store.code}</span>
              <span class="name">${store.name}</span>
              <span class="rank-badge rank-${store.rank.toLowerCase()}">${store.rank}</span>
            </div>
            <button class="remove-btn" onclick="removeStore('${store.code}')">×</button>
          </div>`)
        .join('');
      updateDistributeButtonState();
    };

    const toggleStoreStatus = (storeCode, isActive) => {
      const store = allStores.find(s => s.code === storeCode);
      if (store) {
        store.active = isActive;
        updateStoreCounts();
        saveUserPreferences();
        updateDistributeButtonState();
      }
    };

    const toggleAllStores = active => {
      allStores.forEach(s => s.active = active);
      updateStoreStatus();
      saveUserPreferences();
    };

    const removeStore = storeCode => {
      if (confirm(`Delete store ${storeCode}?`)) {
        allStores = allStores.filter(s => s.code !== storeCode);
        updateStoreStatus();
        updateDistributeButtonState();
        saveUserPreferences();
      }
    };

    const addNewStore = () => {
      const code = $('newStoreCode').value.trim();
      const name = $('newStoreName').value.trim();
      const rank = $('newStoreRank').value;
      const active = $('newStoreActive').checked;
      
      if (!code || !name) { alert('Please enter both code and name'); return; }
      if (allStores.find(s => s.code === code)) { alert('Store code already exists'); return; }
      
      allStores.push({code, name: name.toUpperCase(), rank, active});
      ['newStoreCode', 'newStoreName'].forEach(id => $(id).value = '');
      $('newStoreRank').value = 'B';
      $('newStoreActive').checked = true;
      updateStoreStatus();
      switchTab('store', 'manage');
      updateDistributeButtonState();
      saveUserPreferences();
    };

    // New: re-add default stores on demand
    const restoreDefaults = () => {
      if (!confirm('Re-add all default stores? This will overwrite your current list.')) return;
      allStores = cloneDefaults();
      // clear stale prefs so defaults persist on reload
      document.cookie = "allocationBuddyPrefs=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Strict";
      updateStoreStatus();
      updateDistributeButtonState();
      saveUserPreferences();
      showStatus('<strong>✅ Default stores restored.</strong>', 'success');
    };

    // Import handling
    const handleFileUpload = event => {
      const file = event.target.files[0];
      if (!file) return;
      
      $('fileStatus').innerHTML = '📊 Reading file...';
      
      const reader = new FileReader();
      reader.onload = e => {
        try {
          currentWorkbook = XLSX.read(new Uint8Array(e.target.result), {type:'array', cellDates: true, dateNF: 'yyyy-mm-dd'});
          if (currentWorkbook.SheetNames.length === 1) {
            importFromSheet(currentWorkbook.SheetNames[0]);
          } else {
            showSheetSelector();
          }
        } catch (err) {
          $('fileStatus').innerHTML = `❌ Error reading file: ${err.message}`;
        }
      };
      reader.readAsArrayBuffer(file);
    };

    const showSheetSelector = () => {
      const options = currentWorkbook.SheetNames.map(name => `<option value="${name}">${name}</option>`).join('');
      $('fileStatus').innerHTML = `
        <div style="margin: 10px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Sheet to Import:</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="sheetSelector" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">${options}</select>
            <button class="big-button" onclick="importSelectedSheet()" style="padding: 6px 12px; font-size: 12px;">Import</button>
          </div>
          <button class="big-button" onclick="showColumnMapper()" style="margin-top: 8px; width: 100%; font-size: 12px;">Advanced Import (Column Mapping)</button>
        </div>`;
    };

    const importSelectedSheet = () => $('sheetSelector') && importFromSheet($('sheetSelector').value);

    // Keep unknown stores instead of skipping
    const importFromSheet = (sheetName, columnMapping = null) => {
      try {
        let debugOutput = '';

        const rows = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[sheetName], {header:1, defval:'', raw: false});
        if (rows.length === 0) {
          $('fileStatus').innerHTML = '⚠️ Sheet is empty';
          return;
        }

        let headerRow = -1, itemCol = 0, qtyCol = 1, storeCol = 2;
        
        if (!columnMapping) {
          for (let i = 0; i < Math.min(5, rows.length); i++) {
            const row = rows[i];
            const itemPatterns = /(item|style|item\s*no|item\s*number)/i;
            const qtyPatterns = /(qty|quantity|allocations)/i;
            
            let foundItem = false, foundQty = false, foundStore = false;
            
            row.forEach((cell, idx) => {
              const cellStr = String(cell).toLowerCase().trim();
              if (itemPatterns.test(cellStr) && !foundItem) { itemCol = idx; foundItem = true; }
              if (qtyPatterns.test(cellStr) && !foundQty)  { qtyCol  = idx; foundQty  = true; }
              if (!foundStore) {
                if (/^\d{3}$/.test(cellStr)) { storeCol = idx; foundStore = true; }
                else if (/(store|location|dest|code)/i.test(cellStr)) { storeCol = idx; foundStore = true; }
              }
            });
            
            if (foundItem || foundQty) { headerRow = i; break; }
            if (foundStore && !foundItem && !foundQty && i === 0) { headerRow = -1; break; }
          }
          
          if (headerRow === -1 && rows.length > 0) {
            rows[0].forEach((cell, idx) => { if (/^\d{3}$/.test(String(cell).trim())) storeCol = idx; });
          }
        } else {
          ({itemCol, qtyCol, storeCol, headerRow} = columnMapping);
        }

        let imported = 0, skipped = 0;
        const errors = [];
        
        rows.forEach((row, idx) => {
          if (idx <= headerRow) return;
          
          const itemNumber = String(row[itemCol] || '').trim();
          const quantityRaw = row[qtyCol];
          const storeIdentifierRaw = String(row[storeCol] || '').trim();
          const storeIdentifier = storeIdentifierRaw.replace(/^0+/, '');
          
          let quantity = typeof quantityRaw === 'number' ? quantityRaw : 
            parseFloat(String(quantityRaw).replace(/[^\d.-]/g, ''));
          
          if (!itemNumber || !Number.isFinite(quantity) || quantity <= 0 || !storeIdentifier) {
            if (itemNumber || quantityRaw || storeIdentifier) {
              skipped++; errors.push(`Row ${idx + 1}: Invalid data`);
            }
            return;
          }
          
          const store = findStoreByCodeOrName(storeIdentifier);
          if (!store) {
            itemsToSort.push({
              itemNumber: itemNumber.toUpperCase(),
              quantity: Math.floor(quantity),
              storeCode: storeIdentifier,
              source: `Excel (${sheetName})`
            });
            imported++;
            return;
          }
          
          itemsToSort.push({
            itemNumber: itemNumber.toUpperCase(),
            quantity: Math.floor(quantity),
            storeCode: store.code,
            source: `Excel (${sheetName})`
          });
          imported++;
        });

        let statusMsg = `✅ Imported ${imported} items from "${sheetName}"`;
        if (skipped > 0) {
          statusMsg += ` (${skipped} rows skipped)`;
          if (errors.length <= 5) {
            statusMsg += `<div style="font-size: 11px; color: #666; margin-top: 5px;">Issues: ${errors.join('; ')}</div>`;
          } else if (errors.length > 5) {
            statusMsg += `<div style="font-size: 11px; color: #666; margin-top: 5px;">${errors.length} rows had issues</div>`;
          }
        }
        
        statusMsg += debugOutput;
        
        $('fileStatus').innerHTML = statusMsg;
        updateImportDisplay();
      } catch (err) {
        $('fileStatus').innerHTML = `❌ Import error: ${err.message}`;
      }
    };

    const showColumnMapper = () => {
      const sheetName = $('sheetSelector').value;
      const rows = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[sheetName], {header:1, defval:'', raw: false});
      if (rows.length === 0) return;
      
      const previewRows = rows.slice(0, 5);
      $('fileStatus').innerHTML = `
        <div style="margin: 10px 0;">
          <h4>Column Mapping for "${sheetName}"</h4>
          <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin: 8px 0; max-height: 150px; overflow: auto;">
            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
              ${previewRows.map((row, idx) => `
                <tr style="border-bottom: 1px solid #ddd;">
                  <td style="padding: 2px 4px; font-weight: bold; background: #eee;">${idx + 1}</td>
                  ${row.slice(0, 10).map((cell, colIdx) => `
                    <td style="padding: 2px 4px;" title="Column ${String.fromCharCode(65 + colIdx)}: ${String(cell)}">${String(cell).substring(0, 15)}</td>
                  `).join('')}
                </tr>
              `).join('')}
            </table>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 8px 0;">
            ${['Item', 'Quantity', 'Store'].map((label, i) => `
              <div>
                <label style="font-size: 12px; font-weight: 500;">${label} Column:</label>
                <select id="${['item', 'qty', 'store'][i]}ColSelect" style="width: 100%; padding: 4px;">
                  ${rows[0].map((_, idx) => `<option value="${idx}" ${idx === i ? 'selected' : ''}>Column ${String.fromCharCode(65 + idx)} (${String(rows[0][idx]).substring(0, 10)})</option>`).join('')}
                </select>
                ${i === 2 ? '<div style="font-size: 10px; color: #666; margin-top: 2px;">Accepts store codes or names</div>' : ''}
              </div>
            `).join('')}
          </div>
          <div style="margin: 8px 0;">
            <label style="font-size: 12px; font-weight: 500;">Header Row (skip this many rows):</label>
            <input type="number" id="headerRowInput" value="0" min="0" max="10" style="width: 60px; padding: 4px;">
          </div>
          <button class="big-button success" onclick="importWithMapping()" style="width: 100%; font-size: 12px;">Import with Custom Mapping</button>
        </div>`;
    };

    const importWithMapping = () => {
      const columnMapping = {
        itemCol: parseInt($('itemColSelect').value),
        qtyCol: parseInt($('qtyColSelect').value),
        storeCol: parseInt($('storeColSelect').value),
        headerRow: parseInt($('headerRowInput').value) - 1
      };
      importFromSheet($('sheetSelector').value, columnMapping);
    };

    const processPastedData = () => {
      const pasteData = $('pasteArea').value.trim();
      if (!pasteData) { alert('Please paste some data first'); return; }
      
      const lines = pasteData.split('\n').filter(line => line.trim());
      let imported = 0, skipped = 0;
      const errors = [];
      
      lines.forEach((line, idx) => {
        const parts = (line.includes('\t') ? line.split('\t') : line.split(',')).map(p => p.trim()).filter(p => p);
        if (parts.length < 3) {
          skipped++;
          errors.push(`Line ${idx + 1}: Insufficient data`);
          return;
        }
        
        const [itemNumber, quantityStr, storeIdentifier] = parts;
        const quantity = parseInt(quantityStr, 10);
        
        if (!itemNumber || !Number.isFinite(quantity) || quantity <= 0 || !storeIdentifier) {
          skipped++;
          errors.push(`Line ${idx + 1}: Invalid data`);
          return;
        }
        
        const store = findStoreByCodeOrName(storeIdentifier);
        if (!store) {
          itemsToSort.push({itemNumber, quantity, storeCode: storeIdentifier, source:'Paste'});
          imported++;
          return;
        }
        
        itemsToSort.push({itemNumber, quantity, storeCode: store.code, source:'Paste'});
        imported++;
      });
      
      if (imported > 0) {
        $('pasteArea').value = '';
        updateImportDisplay();
        let message = `✅ Added ${imported} items`;
        if (skipped > 0) {
          message += ` (${skipped} rows skipped)`;
          if (errors.length <= 3) message += `\n\nSkipped: ${errors.join('; ')}`;
        }
        alert(message);
      } else {
        alert(`No valid items found${errors.length > 0 ? `\n\nErrors: ${errors.slice(0, 5).join('; ')}` : ''}`);
      }
    };

    const updateImportDisplay = () => {
      $('itemCount').textContent = itemsToSort.length;
      $('storeDestinationCount').textContent = [...new Set(itemsToSort.map(item => item.storeCode))].length;
      
      const clearBtn = $('clearBtn');
      if (itemsToSort.length === 0) {
        $('importContainer').innerHTML = '<div class="simple-alert alert-info">No items imported yet.</div>';
        clearBtn.classList.add('hidden');
        updateDistributeButtonState();
        return;
      }
      
      clearBtn.classList.remove('hidden');
      $('importContainer').innerHTML = itemsToSort.map((item, index) => {
        const store = allStores.find(s => s.code === item.storeCode);
        const status = !store ? 'NOT FOUND' : (store.active ? 'ACTIVE' : 'INACTIVE');
        const statusColor = !store ? '#e74c3c' : (store.active ? '#27ae60' : '#f39c12');
        return `
          <div class="queue-item">
            <div>
              <strong>${item.itemNumber}</strong> → ${item.storeCode}
              <div class="details">Qty: ${item.quantity} | <span style="color:${statusColor};">${status}</span> | Source: ${item.source}</div>
            </div>
            <button class="remove-btn" onclick="removeItem(${index})">×</button>
          </div>`;
      }).join('');
      updateDistributeButtonState();
    };

    const removeItem = index => { itemsToSort.splice(index,1); updateImportDisplay(); };
    const clearImport = () => { if(confirm('Clear all items?')){ itemsToSort=[]; updateImportDisplay(); } };

    // Distribution and sorting
    const rankWeight = rank => RANK_WEIGHTS[String(rank).toUpperCase()] || 1;

    const getActiveTargetsInCurrentResults = () => {
      if (!lastResults?.sortedStores) return [];
      const resultCodes = new Set(lastResults.sortedStores.map(s => s.storeCode));
      return allStores
        .filter(s => s.active && resultCodes.has(s.code))
        .sort((a,b) => {
          const w = rankWeight(b.rank) - rankWeight(a.rank);
          return w !== 0 ? w : (parseInt(a.code)||999999) - (parseInt(b.code)||999999);
        });
    };

    const hasProblemAssignments = () => {
      if (lastResults?.issues) return lastResults.issues.some(i => i.type === 'inactive' || i.type === 'not_found');
      return itemsToSort.some(it => {
        const s = allStores.find(x => x.code === it.storeCode);
        return !s || (s && !s.active);
      });
    };

    const distributeProblemItems = () => {
      const targets = getActiveTargetsInCurrentResults();
      if (targets.length === 0) {
        showStatus('<strong>ℹ️ No eligible target stores.</strong> Run "Sort by Store" first, and ensure at least one active store appears in results.', 'info');
        updateDistributeButtonState();
        return {moved:0, lines:0, targets:0};
      }

      redistributionDeltas = {};
      const redistributedItems = [];
      const problemAssignments = [];
      const keep = [];

      itemsToSort.forEach(it => {
        const s = allStores.find(x => x.code === it.storeCode);
        if (!s || !s.active) problemAssignments.push(it); else keep.push(it);
      });

      if (problemAssignments.length === 0) {
        showStatus('<strong>ℹ️ Nothing to distribute.</strong> No items are assigned to inactive or unknown stores.', 'info');
        updateDistributeButtonState();
        return {moved:0, lines:0, targets:targets.length};
      }

      const weights = targets.map(t => rankWeight(t.rank));
      const totalWeight = weights.reduce((a,b) => a+b, 0);
      let movedQty = 0;

      problemAssignments.forEach(src => {
        const qty = src.quantity;
        if (!Number.isFinite(qty) || qty <= 0) return;

        const shares = [];
        let allocated = 0;
        for (let i = 0; i < targets.length; i++) {
          const q = Math.floor(qty * (weights[i] / totalWeight));
          shares.push(q);
          allocated += q;
        }
        let remainder = qty - allocated, rIndex = 0;
        while (remainder-- > 0) shares[rIndex++ % shares.length]++;

        shares.forEach((q, i) => {
          if (q > 0) {
            const sc = targets[i].code;
            const key = `${src.itemNumber}|${sc}`;
            redistributionDeltas[key] = (redistributionDeltas[key] || 0) + q;
            redistributedItems.push({
              itemNumber: src.itemNumber,
              quantity: q,
              storeCode: sc,
              source: 'Redistributed'
            });
            movedQty += q;
          }
        });
      });

      itemsToSort = keep;
      
      redistributedItems.forEach(redItem => {
        const idx = itemsToSort.findIndex(it => 
          it.itemNumber === redItem.itemNumber && it.storeCode === redItem.storeCode
        );
        if (idx >= 0) {
          itemsToSort[idx].quantity += redItem.quantity;
          itemsToSort[idx].source = 'Redistributed';
        } else {
          itemsToSort.push(redItem);
        }
      });

      updateImportDisplay();
      lastResults = null;
      showStatus(`<strong>✅ Redistributed:</strong> ${problemAssignments.length} line(s), ${movedQty} unit(s) → ${targets.length} eligible store(s).`, 'success');
      updateDistributeButtonState();
      return {moved:movedQty, lines:problemAssignments.length, targets:targets.length};
    };

    const distributeAndResort = () => {
      distributeProblemItems();
      sortItems();
      $('fullResultsSection').scrollIntoView({behavior:'smooth'});
    };

    const sortItems = () => {
      if (itemsToSort.length === 0) { alert('Please import some items first'); return; }
      showStatus('<div style="color:var(--pink-1);">Processing…</div>', 'info');
      
      setTimeout(() => {
        const validItems = [];
        const issues = [];
        
        itemsToSort.forEach(item => {
          const store = allStores.find(s => s.code === item.storeCode);
          if (!store) {
            issues.push({type:'not_found', itemNumber:item.itemNumber, quantity:item.quantity, storeCode:item.storeCode, message:`Store ${item.storeCode} not found`});
          } else if (!store.active) {
            issues.push({type:'inactive', itemNumber:item.itemNumber, quantity:item.quantity, storeCode:item.storeCode, storeName:store.name, message:`Store ${item.storeCode} - ${store.name} is inactive`});
          } else {
            validItems.push({itemNumber:item.itemNumber, quantity:item.quantity, storeCode:item.storeCode, storeName:store.name, rank:store.rank});
          }
        });

        const storeGroups = {};
        validItems.forEach(item => {
          const key = item.storeCode;
          if (!storeGroups[key]) {
            storeGroups[key] = {storeCode:key, storeName:item.storeName, rank:item.rank, items:[], totalQuantity:0};
          }
          storeGroups[key].items.push(item);
          storeGroups[key].totalQuantity += item.quantity;
        });

        const sortedStores = sortStoresNumerically(Object.values(storeGroups));
        displayResults({validItems, sortedStores, issues});
        lastResults = {validItems, sortedStores, issues};

        showStatus('<strong>✅ Complete.</strong> Results updated.', 'success');
        $('totalProcessed').textContent = validItems.length + issues.length;

        const section = $('fullResultsSection');
        section.classList.remove('hidden');
        updateDistributeButtonState();
        section.scrollIntoView({behavior:'smooth'});
      }, 80);
    };

    // Copy utilities
    const buildStoreClipboardText = (storeCode, asCSV) => {
      const store = lastResults?.sortedStores?.find(s => s.storeCode === storeCode);
      if (!store?.items?.length) return '';
      return store.items
        .slice()
        .sort((a,b) => a.itemNumber.localeCompare(b.itemNumber))
        .map(it => asCSV ? `${it.itemNumber},${it.quantity}` : `${it.itemNumber}\t${it.quantity}`)
        .join('\n');
    };

    const copyTextToClipboard = async text => {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
        }
        return true;
      } catch(e) { return false; }
    };

    const showToast = msg => {
      const t = $('copyToast');
      t.textContent = msg;
      t.classList.toggle('toast-light', !document.body.classList.contains('dark-mode'));
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    };

    const toggleStoreCollapse = storeCode => {
      collapsedStores[storeCode] = !collapsedStores[storeCode];
      if (lastResults) displayResults(lastResults);
    };

    const copyStoreItems = async (storeCode, evt) => {
      if (!lastResults) { showToast('Nothing to copy yet. Run "Sort by Store" first.'); return; }
      const asCSV = evt && evt.altKey;
      const text = buildStoreClipboardText(storeCode, asCSV);
      if (!text) { showToast('No lines for this store.'); return; }
      const ok = await copyTextToClipboard(text);
      if (ok) {
        showToast(asCSV ? 'Copied CSV: Item,Qty' : 'Copied: Item<TAB>Qty');
        copiedStores[storeCode] = true;
        collapsedStores[storeCode] = true;
        displayResults(lastResults);
      } else {
        showToast('Copy failed');
      }
    };

    // Results display
    const displayResults = ({validItems, sortedStores, issues}) => {
      const hasAnyDeltas = Object.keys(redistributionDeltas).length > 0;

      if (issues.length > 0) {
        $('issuesContainer').classList.remove('hidden');
        const totalIssueQty = issues.reduce((s,i) => s+i.quantity, 0);
        const hasProblems = issues.some(i => i.type === 'inactive' || i.type === 'not_found');

        $('issuesContainer').innerHTML = `
          <div class="simple-alert alert-warning" style="margin-bottom:12px;">
            <strong>⚠️ ${issues.length} Items Need Attention</strong>
          </div>
          <div class="store-pane">
            <div class="store-pane-header">
              <div class="store-pane-title">Items Requiring Manual Handling</div>
              <div class="store-pane-stats">${totalIssueQty} units</div>
            </div>
            <div class="store-pane-body">
              <table class="store-pane-table">
                <thead><tr><th>Item</th><th>Qty</th><th>Store Code</th><th>Issue</th></tr></thead>
                <tbody>
                  ${issues.map(issue => `
                    <tr>
                      <td><strong>${issue.itemNumber}</strong></td>
                      <td>${issue.quantity}</td>
                      <td>${issue.storeCode}</td>
                      <td style="color:${issue.type === 'not_found' ? 'var(--danger)' : 'var(--warning)'};">${issue.message}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
              <div style="display:flex;justify-content:flex-end;margin-top:12px;">
                <button id="distributeBtn" class="big-button" onclick="distributeAndResort()"
                        ${hasProblems ? '' : 'disabled'}
                        title="${hasProblems ? 'Redistribute items from inactive or unknown stores' : 'No problem items to distribute'}">
                  Distribute Problem → Active (Rank-Weighted)
                </button>
              </div>
            </div>
          </div>`;
      } else {
        $('issuesContainer').classList.add('hidden');
        $('issuesContainer').innerHTML = '';
      }

      $('resultsContainer').innerHTML = `
        <div class="simple-alert alert-info">
          <strong>📦 Items Sorted by Store</strong> - ${validItems.length} items sorted to ${sortedStores.length} active stores
          ${hasAnyDeltas ? `<div class="legend-note">Green tags/rows indicate units added by the <em>last redistribution</em>.</div>` : ''}
        </div>
        <div class="store-panes">
          ${sortedStores.map(store => {
            const itemsSorted = store.items.slice().sort((a,b) => a.itemNumber.localeCompare(b.itemNumber));
            const storeDelta = itemsSorted.reduce((sum,it) => sum + (redistributionDeltas[`${it.itemNumber}|${store.storeCode}`] || 0), 0);
            const isCollapsed = collapsedStores[store.storeCode];
            const isCopied = copiedStores[store.storeCode];

            return `
              <div class="store-pane ${isCollapsed ? 'collapsed' : ''}">
                <div class="store-pane-header">
                  <div class="store-pane-title">
                    <button class="collapse-toggle" onclick="toggleStoreCollapse('${store.storeCode}')" title="${isCollapsed ? 'Expand' : 'Collapse'}">
                      <span class="chev">▾</span> ${isCollapsed ? 'Expand' : 'Collapse'}
                    </button>
                    ${store.storeCode} - ${store.storeName}
                    <span class="rank-badge rank-${store.rank.toLowerCase()}" style="margin-left:4px;background:rgba(255,255,255,0.2);">${store.rank}</span>
                    ${isCopied ? '<span class="copied-badge" title="Copied to clipboard">Copied</span>' : ''}
                  </div>
                  <div class="store-pane-stats">
                    ${store.totalQuantity} units total
                    ${storeDelta > 0 ? `<span class="delta-badge">+${storeDelta} redistributed</span>` : ''}
                    <button class="copy-btn" title="Copy Item & Qty (Tab). Hold Alt for CSV" onclick="copyStoreItems('${store.storeCode}', event)">📋 Copy</button>
                  </div>
                </div>
                <div class="store-pane-body">
                  <table class="store-pane-table">
                    <thead><tr><th>Item</th><th>Qty</th><th>Code</th></tr></thead>
                    <tbody>
                      ${itemsSorted.map(it => {
                        const d = redistributionDeltas[`${it.itemNumber}|${store.storeCode}`] || 0;
                        const rowClass = d > 0 ? 'redistributed-row' : '';
                        return `
                        <tr class="${rowClass}">
                          <td><strong>${it.itemNumber}</strong></td>
                          <td>${it.quantity}${d>0 ? ` <span class="delta-badge">+${d}</span>` : ''}</td>
                          <td>${store.storeCode}</td>
                        </tr>`;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>`;
          }).join('')}
        </div>`;
      updateDistributeButtonState();
    };

    // Export functionality
    const exportResults = () => {
      if (!lastResults && itemsToSort.length === 0) {
        alert('No data to export. Please import and sort items first.');
        return;
      }
      
      const wb = XLSX.utils.book_new();
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;

      const dataSource = lastResults || generateQuickResults();
      const rows = [['Store Code','Store Name','Rank','Item','Qty']];
      
      if (dataSource.sortedStores?.length) {
        dataSource.sortedStores
          .slice()
          .sort((a,b) => (parseInt(a.storeCode)||999999) - (parseInt(b.storeCode)||999999))
          .forEach(store => {
            store.items
              .slice()
              .sort((a,b) => a.itemNumber.localeCompare(b.itemNumber))
              .forEach(it => rows.push([store.storeCode, store.storeName, store.rank, it.itemNumber, it.quantity]));
          });
      }

      const wsAll = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, wsAll, 'All Stores');

      if (dataSource.issues?.length) {
        const issuesRows = [['Item','Qty','Store Code','Issue']];
        dataSource.issues.forEach(i => issuesRows.push([i.itemNumber, i.quantity, i.storeCode, i.message]));
        const wsIssues = XLSX.utils.aoa_to_sheet(issuesRows);
        XLSX.utils.book_append_sheet(wb, wsIssues, 'Issues');
      }

      XLSX.writeFile(wb, `Inventory_Sorting_${stamp}.xlsx`);
    };

    const generateQuickResults = () => {
      const issues = [];
      const storeGroups = {};
      
      itemsToSort.forEach(item => {
        const store = allStores.find(s => s.code === item.storeCode);
        if (!store) {
          issues.push({type:'not_found', ...item, message:`Store ${item.storeCode} not found`});
          return;
        }
        if (!store.active) {
          issues.push({type:'inactive', ...item, storeName:store.name, message:`Store ${item.storeCode} - ${store.name} is inactive`});
          return;
        }
        
        const key = store.code;
        if (!storeGroups[key]) {
          storeGroups[key] = {storeCode: key, storeName: store.name, rank: store.rank, items: [], totalQuantity: 0};
        }
        storeGroups[key].items.push({itemNumber: item.itemNumber, quantity: item.quantity, storeCode: key, storeName: store.name, rank: store.rank});
        storeGroups[key].totalQuantity += item.quantity;
      });
      
      return {
        sortedStores: sortStoresNumerically(Object.values(storeGroups)),
        issues,
        validItems: Object.values(storeGroups).flatMap(s => s.items)
      };
    };

    const startOver = () => {
      if (confirm('Start over? This will clear everything.')) {
        try {
          itemsToSort.length = 0;
          lastResults = null;
          redistributionDeltas = {};
          currentWorkbook = null;
          for (let key in collapsedStores) delete collapsedStores[key];
          for (let key in copiedStores) delete copiedStores[key];
          const fileInput = $('fileInput');
          const pasteArea = $('pasteArea');
          const fileStatus = $('fileStatus');
          if (fileInput) { fileInput.value = ''; fileInput.files = null; }
          if (pasteArea) pasteArea.value = '';
          if (fileStatus) fileStatus.innerHTML = '';
          const sortingStatus = $('sortingStatus');
          const resultsStatus = $('resultsStatus');
          if (sortingStatus) sortingStatus.innerHTML = '';
          if (resultsStatus) resultsStatus.innerHTML = '';
          const fullResultsSection = $('fullResultsSection');
          const resultsContainer = $('resultsContainer');
          const issuesContainer = $('issuesContainer');
          if (fullResultsSection) fullResultsSection.classList.add('hidden');
          if (resultsContainer) resultsContainer.innerHTML = '';
          if (issuesContainer) { issuesContainer.innerHTML = ''; issuesContainer.classList.add('hidden'); }
          ['itemCount','storeDestinationCount','totalProcessed'].forEach(id => $(id).textContent = '0');
          updateImportDisplay();
          updateDistributeButtonState();
          updateStoreCounts();
          setTimeout(() => showStatus('<strong>✅ Reset complete.</strong> Ready for new data.', 'success'), 100);
        } catch (error) {
          alert(`Reset encountered an error: ${error.message}. Please refresh the page.`);
        }
      }
    };

    const toggleDarkMode = () => {
      const body = document.body;
      const toggleSwitch = $('toggleSwitch');
      const modeIcon = $('modeIcon');
      body.classList.toggle('dark-mode');
      toggleSwitch.classList.toggle('active');
      modeIcon.textContent = body.classList.contains('dark-mode') ? '🌙' : '☀️';
      saveUserPreferences();
    };

    const initializeDarkMode = () => {
      const preferences = getCookie(COOKIE_NAME);
      if (!preferences) {
        document.body.classList.add('dark-mode');
        $('toggleSwitch').classList.add('active');
        $('modeIcon').textContent = '🌙';
      }
    };

    const updateDistributeButtonState = () => {
      const btn = $('distributeBtn');
      if (!btn) return;
      const needed = hasProblemAssignments();
      const hasEligibleTargets = getActiveTargetsInCurrentResults().length > 0;
      btn.disabled = !(needed && hasEligibleTargets);
      btn.title = !needed ? 'No inactive or unknown-store items to distribute' : 
                  (!hasEligibleTargets ? 'No eligible target stores in current results' : 'Redistribute problem items to active stores (rank-weighted)');
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $('helpOverlay').style.display === 'flex') hideHelpOverlay();
    });

    document.addEventListener('DOMContentLoaded', () => {
      initializeDarkMode();
      loadUserPreferences();
      updateStoreStatus();
      updateImportDisplay();
      updateDistributeButtonState();
    });
  </script>
</body>
</html>
